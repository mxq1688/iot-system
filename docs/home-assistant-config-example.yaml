# Home Assistant é…ç½®ç¤ºä¾‹
# å¤åˆ¶æ­¤æ–‡ä»¶å†…å®¹åˆ°ä½ çš„ Home Assistant configuration.yaml ä¸­

# =============================================================================
# MQTT è¿æ¥é…ç½®
# =============================================================================
mqtt:
  broker: 192.168.1.100  # æ›¿æ¢ä¸ºä½ çš„IoTå¹³å°æœåŠ¡å™¨IP
  port: 1883
  username: admin         # EMQXç”¨æˆ·å
  password: public        # EMQXå¯†ç 
  discovery: true         # å¯ç”¨MQTTè‡ªåŠ¨å‘ç°
  discovery_prefix: homeassistant
  birth_message:
    topic: 'homeassistant/status'
    payload: 'online'
  will_message:
    topic: 'homeassistant/status'
    payload: 'offline'

# =============================================================================
# ä¼ æ„Ÿå™¨é…ç½® (Sensors)
# =============================================================================
sensor:
  # æ¸©åº¦ä¼ æ„Ÿå™¨ç¤ºä¾‹
  - platform: mqtt
    name: "å®¢å…æ¸©åº¦ä¼ æ„Ÿå™¨"
    state_topic: "iot/device/temp-sensor-001/data"
    value_template: "{{ value_json.temperature }}"
    unit_of_measurement: "Â°C"
    device_class: temperature
    unique_id: "iot_temp_sensor_001"
    icon: mdi:thermometer

  # æ¹¿åº¦ä¼ æ„Ÿå™¨ç¤ºä¾‹
  - platform: mqtt
    name: "å®¢å…æ¹¿åº¦ä¼ æ„Ÿå™¨"
    state_topic: "iot/device/temp-sensor-001/data"
    value_template: "{{ value_json.humidity }}"
    unit_of_measurement: "%"
    device_class: humidity
    unique_id: "iot_humidity_sensor_001"
    icon: mdi:water-percent

  # PM2.5ä¼ æ„Ÿå™¨ç¤ºä¾‹
  - platform: mqtt
    name: "å®¤å†…PM2.5"
    state_topic: "iot/device/air-quality-001/data"
    value_template: "{{ value_json.pm25 }}"
    unit_of_measurement: "Î¼g/mÂ³"
    device_class: pm25
    unique_id: "iot_pm25_sensor_001"
    icon: mdi:air-filter

  # ç”µé‡ä¼ æ„Ÿå™¨ç¤ºä¾‹
  - platform: mqtt
    name: "æ™ºèƒ½æ’åº§ç”µé‡"
    state_topic: "iot/device/smart-plug-001/data"
    value_template: "{{ value_json.power }}"
    unit_of_measurement: "W"
    device_class: power
    unique_id: "iot_power_sensor_001"
    icon: mdi:flash

# =============================================================================
# äºŒå€¼ä¼ æ„Ÿå™¨é…ç½® (Binary Sensors)
# =============================================================================
binary_sensor:
  # è®¾å¤‡åœ¨çº¿çŠ¶æ€
  - platform: mqtt
    name: "æ¸©åº¦ä¼ æ„Ÿå™¨åœ¨çº¿çŠ¶æ€"
    state_topic: "iot/device/temp-sensor-001/status"
    value_template: "{{ 'ON' if value_json.status == 'online' else 'OFF' }}"
    device_class: connectivity
    unique_id: "iot_temp_sensor_001_status"

  # é—¨çª—ä¼ æ„Ÿå™¨
  - platform: mqtt
    name: "å‰é—¨çŠ¶æ€"
    state_topic: "iot/device/door-sensor-001/data"
    value_template: "{{ 'ON' if value_json.opened else 'OFF' }}"
    device_class: door
    unique_id: "iot_door_sensor_001"
    payload_on: "ON"
    payload_off: "OFF"

  # äººä½“ä¼ æ„Ÿå™¨
  - platform: mqtt
    name: "å®¢å…äººä½“æ„Ÿåº”"
    state_topic: "iot/device/motion-sensor-001/data"
    value_template: "{{ 'ON' if value_json.motion else 'OFF' }}"
    device_class: motion
    unique_id: "iot_motion_sensor_001"
    off_delay: 60  # 60ç§’æ— äººåè‡ªåŠ¨å…³é—­

# =============================================================================
# å¼€å…³é…ç½® (Switches)
# =============================================================================
switch:
  # æ™ºèƒ½æ’åº§å¼€å…³
  - platform: mqtt
    name: "å®¢å…æ™ºèƒ½æ’åº§"
    state_topic: "iot/device/smart-plug-001/status"
    command_topic: "iot/device/smart-plug-001/control"
    value_template: "{{ value_json.power }}"
    payload_on: '{"action":"switch","params":{"power":"on"},"requestId":"{{now().timestamp()}}"}'
    payload_off: '{"action":"switch","params":{"power":"off"},"requestId":"{{now().timestamp()}}"}'
    state_on: "on"
    state_off: "off"
    optimistic: false
    qos: 1
    retain: false
    unique_id: "iot_smart_plug_001"
    icon: mdi:power-socket

  # é£æ‰‡å¼€å…³
  - platform: mqtt
    name: "å§å®¤é£æ‰‡"
    state_topic: "iot/device/fan-001/status"
    command_topic: "iot/device/fan-001/control"
    value_template: "{{ value_json.power }}"
    payload_on: '{"action":"switch","params":{"power":"on"},"requestId":"{{now().timestamp()}}"}'
    payload_off: '{"action":"switch","params":{"power":"off"},"requestId":"{{now().timestamp()}}"}'
    state_on: "on"
    state_off: "off"
    unique_id: "iot_fan_001"
    icon: mdi:fan

# =============================================================================
# ç¯å…‰é…ç½® (Lights)
# =============================================================================
light:
  # å¯è°ƒå…‰ç¯æ³¡
  - platform: mqtt
    name: "å®¢å…å¸é¡¶ç¯"
    state_topic: "iot/device/light-001/status"
    command_topic: "iot/device/light-001/control"
    brightness_state_topic: "iot/device/light-001/data"
    brightness_command_topic: "iot/device/light-001/control"
    brightness_scale: 100
    brightness_value_template: "{{ value_json.brightness }}"
    payload_on: '{"action":"switch","params":{"power":"on"},"requestId":"{{now().timestamp()}}"}'
    payload_off: '{"action":"switch","params":{"power":"off"},"requestId":"{{now().timestamp()}}"}'
    set_brightness_template: '{"action":"adjustBrightness","params":{"brightness":{{ brightness }}},"requestId":"{{now().timestamp()}}"}'
    state_value_template: "{{ value_json.power }}"
    optimistic: false
    qos: 1
    unique_id: "iot_light_001"

  # RGBç¯å¸¦
  - platform: mqtt
    name: "å®¢å…RGBç¯å¸¦"
    state_topic: "iot/device/rgb-light-001/status"
    command_topic: "iot/device/rgb-light-001/control"
    brightness_state_topic: "iot/device/rgb-light-001/data"
    brightness_command_topic: "iot/device/rgb-light-001/control"
    rgb_state_topic: "iot/device/rgb-light-001/data"
    rgb_command_topic: "iot/device/rgb-light-001/control"
    brightness_scale: 100
    rgb_value_template: "{{ value_json.r }},{{ value_json.g }},{{ value_json.b }}"
    payload_on: '{"action":"switch","params":{"power":"on"}}'
    payload_off: '{"action":"switch","params":{"power":"off"}}'
    set_brightness_template: '{"action":"adjustBrightness","params":{"brightness":{{ brightness }}}}'
    set_rgb_template: '{"action":"setColor","params":{"color":"rgb({{ red }},{{ green }},{{ blue }})"}}'
    optimistic: false
    unique_id: "iot_rgb_light_001"

# =============================================================================
# è‡ªåŠ¨åŒ–è§„åˆ™ (Automations)
# =============================================================================
automation:
  # ============== æ¸©åº¦æ§åˆ¶ ==============
  - alias: "æ¸©åº¦è¿‡é«˜è‡ªåŠ¨å¼€å¯é£æ‰‡"
    description: "å½“æ¸©åº¦è¶…è¿‡30Â°Cæ—¶è‡ªåŠ¨å¼€å¯é£æ‰‡"
    trigger:
      - platform: numeric_state
        entity_id: sensor.å®¢å…æ¸©åº¦ä¼ æ„Ÿå™¨
        above: 30
    condition:
      - condition: state
        entity_id: switch.å§å®¤é£æ‰‡
        state: 'off'
    action:
      - service: switch.turn_on
        target:
          entity_id: switch.å§å®¤é£æ‰‡
      - service: notify.mobile_app
        data:
          message: "æ¸©åº¦è¿‡é«˜({{ states('sensor.å®¢å…æ¸©åº¦ä¼ æ„Ÿå™¨') }}Â°C)ï¼Œå·²è‡ªåŠ¨å¼€å¯é£æ‰‡"
          title: "âš ï¸ æ¸©åº¦å‘Šè­¦"

  - alias: "æ¸©åº¦æ¢å¤æ­£å¸¸å…³é—­é£æ‰‡"
    description: "å½“æ¸©åº¦ä½äº25Â°Cæ—¶è‡ªåŠ¨å…³é—­é£æ‰‡"
    trigger:
      - platform: numeric_state
        entity_id: sensor.å®¢å…æ¸©åº¦ä¼ æ„Ÿå™¨
        below: 25
    condition:
      - condition: state
        entity_id: switch.å§å®¤é£æ‰‡
        state: 'on'
    action:
      - service: switch.turn_off
        target:
          entity_id: switch.å§å®¤é£æ‰‡
      - service: notify.mobile_app
        data:
          message: "æ¸©åº¦æ¢å¤æ­£å¸¸({{ states('sensor.å®¢å…æ¸©åº¦ä¼ æ„Ÿå™¨') }}Â°C)ï¼Œå·²å…³é—­é£æ‰‡"
          title: "âœ… æ¸©åº¦æ­£å¸¸"

  # ============== ç©ºæ°”è´¨é‡ç›‘æ§ ==============
  - alias: "ç©ºæ°”è´¨é‡å‘Šè­¦"
    description: "PM2.5è¶…æ ‡æ—¶å‘é€é€šçŸ¥"
    trigger:
      - platform: numeric_state
        entity_id: sensor.å®¤å†…pm25
        above: 75  # è½»åº¦æ±¡æŸ“
    action:
      - service: persistent_notification.create
        data:
          title: "ğŸŒ«ï¸ ç©ºæ°”è´¨é‡å‘Šè­¦"
          message: "å®¤å†…PM2.5è¾¾åˆ° {{ states('sensor.å®¤å†…pm25') }} Î¼g/mÂ³ï¼Œå»ºè®®å¼€å¯ç©ºæ°”å‡€åŒ–å™¨"
      - service: notify.mobile_app
        data:
          message: "PM2.5: {{ states('sensor.å®¤å†…pm25') }} Î¼g/mÂ³"
          title: "ç©ºæ°”è´¨é‡å‘Šè­¦"

  # ============== è®¾å¤‡ç¦»çº¿å‘Šè­¦ ==============
  - alias: "è®¾å¤‡ç¦»çº¿é€šçŸ¥"
    description: "å½“è®¾å¤‡ç¦»çº¿æ—¶å‘é€é€šçŸ¥"
    trigger:
      - platform: mqtt
        topic: "iot/device/+/status"
    condition:
      - condition: template
        value_template: "{{ trigger.payload_json.status == 'offline' }}"
    action:
      - service: persistent_notification.create
        data:
          title: "âš ï¸ è®¾å¤‡ç¦»çº¿"
          message: "è®¾å¤‡ {{ trigger.topic.split('/')[2] }} å·²ç¦»çº¿ï¼Œè¯·æ£€æŸ¥è®¾å¤‡çŠ¶æ€"

  # ============== è®¾å¤‡å‘Šè­¦å¤„ç† ==============
  - alias: "å¤„ç†IoTå¹³å°å‘Šè­¦"
    description: "æ¥æ”¶IoTå¹³å°çš„å‘Šè­¦æ¶ˆæ¯"
    trigger:
      - platform: mqtt
        topic: "iot/device/+/alarm"
    action:
      - service: notify.mobile_app
        data:
          message: |
            è®¾å¤‡ID: {{ trigger.topic.split('/')[2] }}
            å‘Šè­¦ç±»å‹: {{ trigger.payload_json.alarmType }}
            å‘Šè­¦çº§åˆ«: {{ trigger.payload_json.level }}
            å‘Šè­¦å€¼: {{ trigger.payload_json.value }}
          title: "âš ï¸ IoTè®¾å¤‡å‘Šè­¦"

  # ============== äººä½“æ„Ÿåº”è”åŠ¨ ==============
  - alias: "äººä½“æ„Ÿåº”å¼€ç¯"
    description: "æ£€æµ‹åˆ°äººä½“ç§»åŠ¨æ—¶è‡ªåŠ¨å¼€ç¯"
    trigger:
      - platform: state
        entity_id: binary_sensor.å®¢å…äººä½“æ„Ÿåº”
        to: 'on'
    condition:
      - condition: sun
        after: sunset
        before: sunrise
      - condition: state
        entity_id: light.å®¢å…å¸é¡¶ç¯
        state: 'off'
    action:
      - service: light.turn_on
        target:
          entity_id: light.å®¢å…å¸é¡¶ç¯
        data:
          brightness_pct: 60

  - alias: "äººä½“æ„Ÿåº”å…³ç¯"
    description: "5åˆ†é’Ÿæ— äººç§»åŠ¨è‡ªåŠ¨å…³ç¯"
    trigger:
      - platform: state
        entity_id: binary_sensor.å®¢å…äººä½“æ„Ÿåº”
        to: 'off'
        for:
          minutes: 5
    action:
      - service: light.turn_off
        target:
          entity_id: light.å®¢å…å¸é¡¶ç¯

  # ============== åœºæ™¯è§¦å‘ ==============
  - alias: "è§¦å‘IoTå¹³å°åœºæ™¯"
    description: "é€šè¿‡Home Assistantè§¦å‘IoTå¹³å°çš„åœºæ™¯"
    trigger:
      - platform: event
        event_type: call_service
        event_data:
          domain: script
          service: activate_iot_scene
    action:
      - service: mqtt.publish
        data:
          topic: "iot/scene/{{ trigger.event.data.service_data.scene_id }}/trigger"
          payload: |
            {
              "sceneId": "{{ trigger.event.data.service_data.scene_id }}",
              "userId": "homeassistant"
            }

# =============================================================================
# è„šæœ¬ (Scripts)
# =============================================================================
script:
  # ç¦»å®¶æ¨¡å¼
  leaving_home:
    alias: "ç¦»å®¶æ¨¡å¼"
    sequence:
      # å…³é—­æ‰€æœ‰ç¯å…‰
      - service: light.turn_off
        target:
          entity_id: all
      # å…³é—­æ‰€æœ‰å¼€å…³
      - service: switch.turn_off
        target:
          entity_id:
            - switch.å®¢å…æ™ºèƒ½æ’åº§
            - switch.å§å®¤é£æ‰‡
      # è§¦å‘IoTå¹³å°çš„ç¦»å®¶åœºæ™¯
      - service: mqtt.publish
        data:
          topic: "iot/scene/leaving-home/trigger"
          payload: '{"sceneId":"leaving-home","userId":"homeassistant"}'
      - service: notify.mobile_app
        data:
          message: "å·²å¯åŠ¨ç¦»å®¶æ¨¡å¼ï¼Œæ‰€æœ‰è®¾å¤‡å·²å…³é—­"
          title: "ğŸ  ç¦»å®¶æ¨¡å¼"

  # å›å®¶æ¨¡å¼
  arriving_home:
    alias: "å›å®¶æ¨¡å¼"
    sequence:
      # æ‰“å¼€å®¢å…ç¯å…‰
      - service: light.turn_on
        target:
          entity_id: light.å®¢å…å¸é¡¶ç¯
        data:
          brightness_pct: 80
      # è§¦å‘IoTå¹³å°çš„å›å®¶åœºæ™¯
      - service: mqtt.publish
        data:
          topic: "iot/scene/arriving-home/trigger"
          payload: '{"sceneId":"arriving-home","userId":"homeassistant"}'
      - service: notify.mobile_app
        data:
          message: "æ¬¢è¿å›å®¶ï¼å·²å¼€å¯å®¢å…ç¯å…‰"
          title: "ğŸ  å›å®¶æ¨¡å¼"

  # ç¡çœ æ¨¡å¼
  sleep_mode:
    alias: "ç¡çœ æ¨¡å¼"
    sequence:
      # å…³é—­æ‰€æœ‰ç¯å…‰
      - service: light.turn_off
        target:
          entity_id: all
      # å¼€å¯å¤œç¯ï¼ˆä½äº®åº¦ï¼‰
      - service: light.turn_on
        target:
          entity_id: light.å§å®¤åºŠå¤´ç¯
        data:
          brightness_pct: 10
      # è§¦å‘IoTå¹³å°çš„ç¡çœ åœºæ™¯
      - service: mqtt.publish
        data:
          topic: "iot/scene/sleep-mode/trigger"
          payload: '{"sceneId":"sleep-mode","userId":"homeassistant"}'

# =============================================================================
# é€šçŸ¥é…ç½® (Notifications) - å¯é€‰
# =============================================================================
# å¦‚æœä½ æƒ³æ¥æ”¶ç§»åŠ¨é€šçŸ¥ï¼Œéœ€è¦å®‰è£…Home Assistantç§»åŠ¨åº”ç”¨
# å‚è€ƒ: https://companion.home-assistant.io/

# =============================================================================
# Lovelace UI å¡ç‰‡ç¤ºä¾‹
# =============================================================================
# å°†ä»¥ä¸‹å†…å®¹æ·»åŠ åˆ°ä½ çš„ Lovelace dashboard ä¸­

# entities:
#   - entity: sensor.å®¢å…æ¸©åº¦ä¼ æ„Ÿå™¨
#   - entity: sensor.å®¢å…æ¹¿åº¦ä¼ æ„Ÿå™¨
#   - entity: sensor.å®¤å†…pm25
#   - entity: switch.å®¢å…æ™ºèƒ½æ’åº§
#   - entity: switch.å§å®¤é£æ‰‡
#   - entity: light.å®¢å…å¸é¡¶ç¯
# type: entities
# title: IoTè®¾å¤‡çŠ¶æ€

# =============================================================================
# ä½¿ç”¨è¯´æ˜
# =============================================================================
# 1. å°†æœ¬æ–‡ä»¶å†…å®¹å¤åˆ¶åˆ° /config/configuration.yaml
# 2. ä¿®æ”¹ mqtt.broker ä¸ºä½ çš„IoTå¹³å°æœåŠ¡å™¨IP
# 3. ä¿®æ”¹è®¾å¤‡ID (å¦‚ temp-sensor-001) ä¸ºå®é™…è®¾å¤‡ID
# 4. é‡å¯Home Assistant: é…ç½® â†’ æœåŠ¡å™¨æ§åˆ¶ â†’ é‡å¯
# 5. æ£€æŸ¥æ—¥å¿—ç¡®è®¤MQTTè¿æ¥æˆåŠŸ
# 6. åœ¨å¼€å‘è€…å·¥å…· â†’ çŠ¶æ€ ä¸­æŸ¥çœ‹å®ä½“æ˜¯å¦æ­£å¸¸å·¥ä½œ
